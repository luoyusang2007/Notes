# 端口回流/Hairpin
问题：内网用户无法通过公网地址访问内网的WEB服务器。   
其解法，不同厂商的叫法不一样，端口回流/Hairpin/NAT回流都指的是同一个东西。

# 原因
## 一般解释：源 NAT 没有被触发
内网的某个客户端发送的包未被路由器进行源NAT，导致内网中的服务器直接以内网地址回复。内网客户端收到的“连接Accepted”回复包的发送方是服务器的内网地址，所以不会认为自己发出的请求被服务器接受了，连接就无法建立。

## 华为解释（参考2，本人持怀疑态度）：目的NAT没有被触发
由于NatServer配置在WAN口接口上，内网包由于从LAN口送入防火墙/网关/路由器，而端口映射被放在WAN口上，所以没有触发目的NAT。

# 目的 NAT 和源 NAT
改变目的地址叫目的NAT，又叫端口转发/重定向。华为/华三命令是 `nat server`。注意使用反掩码。
改变源地址叫源NAT，又叫出站NAT。在 OpnSense 的配置中有迷惑性。华为/华三命令是 `nat outbound`。注意使用反掩码。

# 把服务器暴露给外网是目的 NAT
要把内网的服务器暴露给外网，是一种目的NAT。如果只映射若干IP，叫端口映射。如果映射一整个IP，就是1:1 NAT(one-to-one)。

匹配：任意地址【从WAN口来】->路由器WAN口IP的特定端口。
NAT：改变目的地址到内网服务器IP和端口

# 解法一 设置额外的目的 NAT（可能无效）
这使得所有流量被限制在内网IP内。注意这个目的NAT一定要包含路由器的LAN口。

匹配：内网->路由器/防火墙的公网IP:映射的服务端口
NAT：改变目的地址为服务器的内网IP:被映射的服务端口

# 解法二 设置源 NAT
在A212实验室的华为路由器上使用了此方法。注意设置目的地址是被访问机器的内网地址。源地址转换成任意外网地址即可。

# 解法三 内网 DNS

# 参考文献
1. 目的NAT方案：https://www.zhihu.com/question/266194635/answer/304295261
2. 华为官方：https://support.huawei.com/enterprise/zh/knowledge/KB1000021808
3. 华三官方：http://www.h3c.com/cn/d_201405/828697_30005_0.htm#_Toc387662360
4. 源NAT方案：https://www.cnblogs.com/Yu-Qing/p/11984297.html